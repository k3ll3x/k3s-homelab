name: Bootstrap k3s Cluster
on:
  workflow_dispatch:
  push:
    branches: [ main ]
    paths: [ 'playbooks/**', 'inventory/**', 'roles/**' ]

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Setup Secrets and Vault
      env:
        ANSIBLE_VAULT_PASSWORD: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}
      run: echo "$ANSIBLE_VAULT_PASSWORD" > vault_pass

    - name: Check local repo
      run: pwd && ls -lah && ls -lah group_vars

    - name: Install Ansible dependencies
      run: ansible-galaxy collection install -r requirements.yml &&
       ansible-galaxy role install -r requirements.yml -p ./roles

    - name: Check Bootstrap Playbook Syntax and List Tasks
      run: ansible-playbook -i inventory/hosts.yml playbooks/07-bootstrap.yml --syntax-check --list-tasks -vv

    - name: Run Bootstrap Playbook
      run: ansible-playbook -i inventory/hosts.yml playbooks/07-bootstrap.yml -vv \
        --extra-vars "@group_vars/all.yml @group_vars/secrets.yml @group_vars/vault.yml"

      #--extra-vars "@group_vars/all.yml @group_vars/secrets.yml @group_vars/vault.yml"

#      if: env.secrets.SSH_PRIVATE_KEY != ''
#              --vault-password-file vault_pass \
