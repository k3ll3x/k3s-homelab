---
- name: Deploy Traefik
  hosts: k3s_server
  tasks:
    - name: Add Traefik Helm repo
      kubernetes.core.helm_repository:
        name: traefik
        repo_url: https://traefik.github.io/charts
      environment:
        KUBECONFIG: "{{ playbook_dir }}/kubeconfig/admin.conf"

    - name: Create traefik-system namespace
      kubernetes.core.k8s:
        name: traefik-system
        api_version: v1
        kind: Namespace
        state: present
      environment:
        KUBECONFIG: "{{ playbook_dir }}/kubeconfig/admin.conf"

    - name: Deploy Traefik Helm chart
      kubernetes.core.helm:
        name: traefik
        chart_ref: traefik/traefik
        namespace: traefik-system
        create_namespace: true
        values: "{{ lookup('file', '../helm/traefik/values.yaml') | from_yaml }}"
      environment:
        KUBECONFIG: "{{ playbook_dir }}/kubeconfig/admin.conf"
